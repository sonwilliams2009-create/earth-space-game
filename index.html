<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ECHS KY - Earth & Space Science</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• REPLACE WITH YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentStudent = "";
let score = 0;
let currentStage = null;
let currentQuestionIndex = 0;

/* ------------------ QUESTION BANK ------------------ */
const stages = {
  stage1: {
    title: "üí• Big Bang & Universe",
    questions: [
      { q: "The Big Bang created?", a: [
        { text: "The Universe", correct: true },
        { text: "Earth", correct: false }
      ]},
      { q: "Universe age?", a: [
        { text: "13.8 billion years", correct: true },
        { text: "1 million years", correct: false }
      ]},
      { q: "Galaxies are moving?", a: [
        { text: "Away from each other", correct: true },
        { text: "Toward each other", correct: false }
      ]}
    ]
  },

  stage2: {
    title: "üåé Earth Layers",
    questions: [
      { q: "Magnetic field comes from?", a: [
        { text: "Outer Core", correct: true },
        { text: "Crust", correct: false }
      ]},
      { q: "Earth‚Äôs densest layer?", a: [
        { text: "Inner Core", correct: true },
        { text: "Mantle", correct: false }
      ]}
    ]
  },

  stage3: {
    title: "üåã Plate Tectonics",
    questions: [
      { q: "Divergent plates?", a: [
        { text: "Move apart", correct: true },
        { text: "Collide", correct: false }
      ]},
      { q: "Ring of Fire surrounds?", a: [
        { text: "Pacific Ocean", correct: true },
        { text: "Atlantic Ocean", correct: false }
      ]}
    ]
  }
};

/* ------------------ SHUFFLE ------------------ */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

/* ------------------ SCREEN CONTROL ------------------ */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
}
window.show = show;

/* ------------------ AUTO LOGIN ------------------ */
window.onload = async function () {
  let savedUser = localStorage.getItem("studentUser");
  if (savedUser) {
    currentStudent = savedUser;
    show("studentMenu");
    loadStudentTopics();
  }
};

/* ------------------ TEACHER LOGIN ------------------ */
window.teacherLogin = function () {
  if (document.getElementById("teacherPass").value === "caves") {
    show("dashboard");
    loadLeaderboard();
  } else {
    alert("Wrong password");
  }
};

/* ------------------ ADD STUDENT + PIN + DEFAULT TOPICS ------------------ */
window.addStudent = async function () {
  let name = document.getElementById("newStudent").value.trim();
  if (!name) return alert("Enter username");

  let pin = Math.floor(1000 + Math.random() * 9000);

  await setDoc(doc(db, "students", name), {
    score: 0,
    pin: pin,

    // Teacher controls unlocked topics
    allowedTopics: {
      stage1: true,
      stage2: false,
      stage3: false
    }
  });

  alert("Student Added!\nUsername: " + name + "\nPIN: " + pin);

  document.getElementById("newStudent").value = "";
  loadLeaderboard();
};

/* ------------------ SAVE TOPIC ACCESS ------------------ */
window.saveTopics = async function () {
  let student = document.getElementById("topicStudent").value.trim();
  if (!student) return alert("Enter student username");

  const ref = doc(db, "students", student);
  const snap = await getDoc(ref);

  if (!snap.exists()) return alert("Student not found!");

  let topics = {
    stage1: document.getElementById("unlock1").checked,
    stage2: document.getElementById("unlock2").checked,
    stage3: document.getElementById("unlock3").checked
  };

  await updateDoc(ref, { allowedTopics: topics });

  alert("Topics updated for " + student);
};

/* ------------------ STUDENT LOGIN (USERNAME + PIN) ------------------ */
window.studentLogin = async function () {
  let name = document.getElementById("studentName").value.trim();
  let pin = document.getElementById("studentPin").value.trim();

  if (!name || !pin) return alert("Enter username and PIN");

  const snap = await getDoc(doc(db, "students", name));

  if (snap.exists()) {
    let data = snap.data();

    if (data.pin == pin) {
      currentStudent = name;
      localStorage.setItem("studentUser", name);

      show("studentMenu");
      loadStudentTopics();
    } else {
      alert("Wrong PIN!");
    }
  } else {
    alert("Student not found");
  }
};

/* ------------------ LOAD STUDENT TOPICS ------------------ */
async function loadStudentTopics() {
  const snap = await getDoc(doc(db, "students", currentStudent));
  let data = snap.data();

  let div = document.getElementById("topicButtons");
  div.innerHTML = "";

  for (let key in stages) {
    if (data.allowedTopics[key]) {
      let btn = document.createElement("button");
      btn.innerText = stages[key].title;
      btn.onclick = function () {
        startStage(key);
      };
      div.appendChild(btn);
    }
  }
}

/* ------------------ LOGOUT ------------------ */
window.logoutStudent = function () {
  localStorage.removeItem("studentUser");
  currentStudent = "";
  show("login");
};

/* ------------------ GAME ------------------ */
window.startStage = function (key) {
  score = 0;
  currentQuestionIndex = 0;
  currentStage = JSON.parse(JSON.stringify(stages[key]));

  shuffle(currentStage.questions);

  show("game");
  showQuestion();
};

function showQuestion() {
  let q = currentStage.questions[currentQuestionIndex];

  document.getElementById("stageTitle").innerText = currentStage.title;
  document.getElementById("question").innerText = q.q;

  let div = document.getElementById("answers");
  div.innerHTML = "";

  shuffle(q.a);

  q.a.forEach(a => {
    let btn = document.createElement("button");
    btn.innerText = a.text;
    btn.onclick = function () {
      checkAnswer(a.correct);
    };
    div.appendChild(btn);
  });
}

async function checkAnswer(correct) {
  if (correct) score += 20;

  currentQuestionIndex++;

  if (currentQuestionIndex < currentStage.questions.length) {
    showQuestion();
  } else {
    const ref = doc(db, "students", currentStudent);
    const snap = await getDoc(ref);

    let total = snap.data().score + score;

    await updateDoc(ref, { score: total });

    alert("Topic Complete!\nStage Score: " + score);

    show("studentMenu");
    loadStudentTopics();
  }
}

/* ------------------ LEADERBOARD (SORTED) ------------------ */
async function loadLeaderboard() {
  let div = document.getElementById("board");
  div.innerHTML = "";

  const q = query(collection(db, "students"), orderBy("score", "desc"));
  const snaps = await getDocs(q);

  snaps.forEach(docSnap => {
    div.innerHTML +=
      "üèÜ " + docSnap.id + " : " +
      docSnap.data().score + " points<br>";
  });
}

</script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #000014;
  color: white;
  text-align: center;
}

#schoolHeader {
  background: #111;
  color: #00e5ff;
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
  border-bottom: 3px solid orange;
}

.screen {
  display: none;
  padding: 30px;
}

#login {
  display: block;
}

button, input {
  padding: 10px;
  margin: 10px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
}

button {
  background: #ff9800;
  cursor: pointer;
}

button:hover {
  background: white;
  color: black;
}
</style>
</head>

<body>

<div id="schoolHeader">
üè´ ECHS KY ‚Äì Earth & Space Science
</div>

<!-- LOGIN SCREEN -->
<div id="login" class="screen">
  <h2>Student Login</h2>
  <input id="studentName" placeholder="Student Username">
  <input id="studentPin" type="password" placeholder="4-digit PIN">
  <button onclick="studentLogin()">Login</button>

  <h2>Teacher Login</h2>
  <input id="teacherPass" type="password" placeholder="Password">
  <button onclick="teacherLogin()">Login</button>
</div>

<!-- TEACHER DASHBOARD -->
<div id="dashboard" class="screen">
  <h2>Teacher Dashboard</h2>

  <input id="newStudent" placeholder="New Student Username">
  <button onclick="addStudent()">Add Student</button>

  <h3>Leaderboard</h3>
  <div id="board"></div>

  <h3>Unlock Topics for Student</h3>
  <input id="topicStudent" placeholder="Student Username">

  <label><input type="checkbox" id="unlock1"> Big Bang</label><br>
  <label><input type="checkbox" id="unlock2"> Earth Layers</label><br>
  <label><input type="checkbox" id="unlock3"> Plate Tectonics</label><br>

  <button onclick="saveTopics()">Save Topic Access</button>

  <button onclick="show('login')">Logout</button>
</div>

<!-- STUDENT MENU -->
<div id="studentMenu" class="screen">
  <h2>Select Topic</h2>
  <div id="topicButtons"></div>

  <button onclick="logoutStudent()">Logout</button>
</div>

<!-- GAME SCREEN -->
<div id="game" class="screen">
  <h2 id="stageTitle"></h2>
  <p id="question"></p>
  <div id="answers"></div>
</div>

</body>
</html>
