<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ECHS KY Earth & Space Science - Full Course</title>

<script type="module">
/* =====================================================
   üî• FIREBASE IMPORTS
===================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =====================================================
   üî• FIREBASE CONFIG (REPLACE)
===================================================== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =====================================================
   GLOBAL VARIABLES
===================================================== */
let currentStudent = "";
let currentUnitKey = "";
let currentUnitData = null;
let currentQuestionIndex = 0;
let score = 0;

/* =====================================================
   üéì FULL YEAR KY UNIT STRUCTURE
   (Questions stored separately)
===================================================== */
const courseUnits = {
  unit1: { title: "Unit 1: Universe & Big Bang" },
  unit2: { title: "Unit 2: Stars & Galaxies" },
  unit3: { title: "Unit 3: Solar System" },
  unit4: { title: "Unit 4: Earth‚Äôs Interior" },
  unit5: { title: "Unit 5: Plate Tectonics" },
  unit6: { title: "Unit 6: Volcanoes & Mountains" },
  unit7: { title: "Unit 7: Weather & Atmosphere" },
  unit8: { title: "Unit 8: Climate Change" },
  unit9: { title: "Unit 9: Oceans & Earth Systems" },
  unit10:{ title: "Unit 10: Human Impact & Resources" }
};

/* =====================================================
   üìö QUESTION BANK (Expandable Forever)
   Add hundreds of questions here safely
===================================================== */
const questionBank = {
  unit1: [
    {
      q: "The Big Bang theory explains‚Ä¶",
      a: [
        { text: "The origin of the universe", correct: true },
        { text: "The origin of oceans", correct: false }
      ]
    },
    {
      q: "The universe is about‚Ä¶",
      a: [
        { text: "13.8 billion years old", correct: true },
        { text: "10,000 years old", correct: false }
      ]
    },
    {
      q: "Galaxies are moving away due to‚Ä¶",
      a: [
        { text: "Expansion of space", correct: true },
        { text: "Earth‚Äôs gravity", correct: false }
      ]
    }
  ],

  unit2: [
    {
      q: "Our Sun is classified as‚Ä¶",
      a: [
        { text: "A main sequence star", correct: true },
        { text: "A black hole", correct: false }
      ]
    },
    {
      q: "A supernova is‚Ä¶",
      a: [
        { text: "A star explosion", correct: true },
        { text: "A comet storm", correct: false }
      ]
    }
  ]
};

/* =====================================================
   üé≤ SHUFFLE
===================================================== */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

/* =====================================================
   SCREEN CONTROL
===================================================== */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
}
window.show = show;

/* =====================================================
   üéµ MUSIC
===================================================== */
let music = new Audio("menu-music.mp3");
music.loop = true;
music.volume = 0.4;

window.toggleMusic = function () {
  if (music.paused) {
    music.play();
    document.getElementById("musicBtn").innerText = "üîä Music ON";
  } else {
    music.pause();
    document.getElementById("musicBtn").innerText = "üîá Music OFF";
  }
};

/* =====================================================
   TEACHER LOGIN
===================================================== */
window.teacherLogin = function () {
  if (document.getElementById("teacherPass").value === "caves") {
    show("dashboard");
    loadLeaderboard();
  } else {
    alert("Wrong password");
  }
};

/* =====================================================
   TEACHER ADD STUDENT
===================================================== */
window.addStudent = async function () {

  let name = document.getElementById("newStudent").value.trim();
  let pin = document.getElementById("newPin").value.trim();

  if (!name) return alert("Enter username");
  if (!pin || pin.length !== 4) return alert("Enter 4-digit PIN");

  let allowed = {};
  Object.keys(courseUnits).forEach(u => allowed[u] = false);

  await setDoc(doc(db, "students", name), {
    score: 0,
    pin: pin,
    allowedUnits: allowed,
    completedUnits: {}
  });

  alert("Student added successfully!");
};

/* =====================================================
   TEACHER ASSIGN UNITS
===================================================== */
window.saveAssignments = async function () {

  let student = document.getElementById("assignStudent").value.trim();
  if (!student) return alert("Enter student username");

  const ref = doc(db, "students", student);
  const snap = await getDoc(ref);
  if (!snap.exists()) return alert("Student not found!");

  let assigned = {};
  Object.keys(courseUnits).forEach((u, i) => {
    assigned[u] = document.getElementById("unitCheck" + (i + 1)).checked;
  });

  await updateDoc(ref, { allowedUnits: assigned });
  alert("Assignments saved!");
};

/* =====================================================
   STUDENT LOGIN
===================================================== */
window.studentLogin = async function () {

  let name = document.getElementById("studentName").value.trim();
  let pin = document.getElementById("studentPin").value.trim();

  const snap = await getDoc(doc(db, "students", name));

  if (snap.exists() && snap.data().pin == pin) {
    currentStudent = name;
    show("studentMenu");
    loadStudentUnits();
  } else {
    alert("Login failed.");
  }
};

/* =====================================================
   LOAD STUDENT UNITS
===================================================== */
async function loadStudentUnits() {

  const snap = await getDoc(doc(db, "students", currentStudent));
  let data = snap.data();

  let div = document.getElementById("unitButtons");
  div.innerHTML = "";

  for (let u in courseUnits) {
    if (data.allowedUnits[u]) {
      let btn = document.createElement("button");
      btn.innerText = courseUnits[u].title;
      btn.onclick = () => startUnit(u);
      div.appendChild(btn);
    }
  }
}

/* =====================================================
   START UNIT GAME
===================================================== */
window.startUnit = function (u) {

  if (!questionBank[u]) {
    alert("No questions added yet for this unit.");
    return;
  }

  score = 0;
  currentQuestionIndex = 0;
  currentUnitKey = u;
  currentUnitData = questionBank[u];

  shuffle(currentUnitData);

  show("game");
  showQuestion();
};

function showQuestion() {

  let q = currentUnitData[currentQuestionIndex];

  document.getElementById("unitTitle").innerText =
    courseUnits[currentUnitKey].title;

  document.getElementById("question").innerText = q.q;

  let div = document.getElementById("answers");
  div.innerHTML = "";

  shuffle(q.a);

  q.a.forEach(ans => {
    let btn = document.createElement("button");
    btn.innerText = ans.text;
    btn.onclick = () => checkAnswer(ans.correct);
    div.appendChild(btn);
  });
}

/* =====================================================
   ANSWER CHECK
===================================================== */
async function checkAnswer(correct) {

  if (correct) score += 20;
  currentQuestionIndex++;

  if (currentQuestionIndex < currentUnitData.length) {
    showQuestion();
  } else {

    const ref = doc(db, "students", currentStudent);
    const snap = await getDoc(ref);

    let total = snap.data().score + score;

    await updateDoc(ref, { score: total });

    alert("Unit Complete! Score earned: " + score);

    show("studentMenu");
    loadStudentUnits();
  }
}

/* =====================================================
   LEADERBOARD
===================================================== */
async function loadLeaderboard() {

  let div = document.getElementById("board");
  div.innerHTML = "";

  const q = query(collection(db, "students"), orderBy("score", "desc"));
  const snaps = await getDocs(q);

  snaps.forEach(docSnap => {
    div.innerHTML += "üèÜ " + docSnap.id + " : " +
      docSnap.data().score + " points<br>";
  });
}

</script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #000014;
  color: white;
  text-align: center;
}
.screen { display: none; padding: 30px; }
#login { display: block; }
button, input {
  padding: 10px;
  margin: 10px;
  border-radius: 8px;
  border: none;
}
button { background: orange; cursor: pointer; }
button:hover { background: white; color: black; }
</style>
</head>

<body>

<h1>üè´ ECHS KY Earth & Space Science</h1>
<button id="musicBtn" onclick="toggleMusic()">üîá Music OFF</button>

<!-- LOGIN -->
<div id="login" class="screen">
  <h2>Student Login</h2>
  <input id="studentName" placeholder="Username">
  <input id="studentPin" placeholder="PIN">
  <button onclick="studentLogin()">Login</button>

  <h2>Teacher Login</h2>
  <input id="teacherPass" type="password">
  <button onclick="teacherLogin()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="screen">
  <h2>Teacher Dashboard</h2>

  <h3>Add Student</h3>
  <input id="newStudent" placeholder="Username">
  <input id="newPin" placeholder="PIN">
  <button onclick="addStudent()">Add Student</button>

  <h3>Leaderboard</h3>
  <div id="board"></div>

  <h3>Assign Units</h3>
  <input id="assignStudent" placeholder="Student Username"><br>

  <label><input type="checkbox" id="unitCheck1"> Unit 1</label><br>
  <label><input type="checkbox" id="unitCheck2"> Unit 2</label><br>
  <label><input type="checkbox" id="unitCheck3"> Unit 3</label><br>
  <label><input type="checkbox" id="unitCheck4"> Unit 4</label><br>
  <label><input type="checkbox" id="unitCheck5"> Unit 5</label><br>
  <label><input type="checkbox" id="unitCheck6"> Unit 6</label><br>
  <label><input type="checkbox" id="unitCheck7"> Unit 7</label><br>
  <label><input type="checkbox" id="unitCheck8"> Unit 8</label><br>
  <label><input type="checkbox" id="unitCheck9"> Unit 9</label><br>
  <label><input type="checkbox" id="unitCheck10"> Unit 10</label><br>

  <button onclick="saveAssignments()">Save Assignments</button>
</div>

<!-- STUDENT MENU -->
<div id="studentMenu" class="screen">
  <h2>Your Assigned Units</h2>
  <div id="unitButtons"></div>
</div>

<!-- GAME -->
<div id="game" class="screen">
  <h2 id="unitTitle"></h2>
  <p id="question"></p>
  <div id="answers"></div>
</div>

</body>
</html>
