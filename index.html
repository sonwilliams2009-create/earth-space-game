<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ECHS KY Earth & Space Science</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= GLOBAL VARIABLES ================= */
let currentStudent = "";
let currentUnitKey = "";
let currentUnitData = null;
let currentQuestionIndex = 0;
let score = 0;

/* ================= KY EARTH & SPACE SCIENCE UNITS ================= */
const courseUnits = {
  unit1: { title: "Big Bang & Origin of the Universe" },
  unit2: { title: "Stars, Galaxies, and Light Years" },
  unit3: { title: "Solar System & Planet Motion" },
  unit4: { title: "Gravity and Orbital Mechanics" },
  unit5: { title: "Earth‚Äôs Interior and Layers" },
  unit6: { title: "Plate Tectonics & Continental Drift" },
  unit7: { title: "Earthquakes and Fault Zones" },
  unit8: { title: "Volcanoes, Mountains, and Subduction" },
  unit9: { title: "Weather Systems and Air Pressure" },
  unit10: { title: "Climate vs Weather & Climate Change" },
  unit11: { title: "Oceans, Currents, and Water Cycle" },
  unit12: { title: "Earth‚Äôs Resources and Sustainability" },
  unit13: { title: "Human Impact on Earth Systems" },
  unit14: { title: "Moon Phases, Eclipses, and Tides" },
  unit15: { title: "Space Exploration and Satellites" },
  unit16: { title: "Meteorology and Severe Storms" },
  unit17: { title: "Earth‚Äôs Magnetic Field and Auroras" },
  unit18: { title: "Rocks, Minerals, and the Rock Cycle" },
  unit19: { title: "Geologic Time Scale and Fossil Evidence" },
  unit20: { title: "Final Review & Exam Prep" }
};

/* ================= QUESTION BANK ================= */
const questionBank = {
  unit1: [
    { q: "The Big Bang theory explains‚Ä¶", a: [{ text: "The origin of the universe", correct: true }, { text: "The origin of oceans", correct: false }] },
    { q: "The universe is approximately‚Ä¶", a: [{ text: "13.8 billion years old", correct: true }, { text: "100,000 years old", correct: false }] }
  ],
  unit5: [
    { q: "Earth‚Äôs magnetic field is produced by‚Ä¶", a: [{ text: "Movement in the outer core", correct: true }, { text: "The crust", correct: false }] },
    { q: "The densest Earth layer is the‚Ä¶", a: [{ text: "Inner core", correct: true }, { text: "Mantle", correct: false }] }
  ],
  unit14: [
    { q: "Moon phases happen because‚Ä¶", a: [{ text: "The Moon orbits Earth", correct: true }, { text: "Earth blocks sunlight permanently", correct: false }] }
  ]
};

/* ================= SHUFFLE FUNCTION ================= */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

/* ================= SCREEN CONTROL ================= */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
}
window.show = show;

/* ================= MENU MUSIC ================= */
let music = new Audio("menu-music.mp3"); // Must exist in folder
music.loop = true;
music.volume = 0.3;
window.toggleMusic = function () {
  if (music.paused) {
    music.play().catch(err => console.log("Click to allow music"));
    document.getElementById("musicBtn").innerText = "üîä Music ON";
  } else {
    music.pause();
    document.getElementById("musicBtn").innerText = "üîá Music OFF";
  }
};

/* ================= TEACHER LOGIN ================= */
window.teacherLogin = function () {
  const pass = document.getElementById("teacherPass").value;
  if (pass === "caves") {
    show("dashboard");
    loadLeaderboard();
    buildTeacherUnitList();
  } else alert("Wrong password");
};

/* ================= TEACHER ADD STUDENT ================= */
window.addStudent = async function () {
  const name = document.getElementById("newStudent").value.trim();
  const pin = document.getElementById("newPin").value.trim();
  if (!name || !pin || pin.length !== 4) return alert("Enter username and 4-digit PIN");
  let allowed = {};
  Object.keys(courseUnits).forEach(u => allowed[u] = false);
  await setDoc(doc(db, "students", name), { score: 0, pin: pin, allowedUnits: allowed, completedUnits: {} });
  alert(`Student added: ${name}\nPIN: ${pin}`);
};

/* ================= TEACHER ASSIGN UNITS ================= */
function buildTeacherUnitList() {
  let div = document.getElementById("unitAssignList");
  div.innerHTML = "";
  let i = 1;
  for (let u in courseUnits) {
    div.innerHTML += `<label><input type="checkbox" id="unitCheck${i}"> ${courseUnits[u].title}</label><br>`;
    i++;
  }
}

window.saveAssignments = async function () {
  const student = document.getElementById("assignStudent").value.trim();
  if (!student) return alert("Enter student username");
  const ref = doc(db, "students", student);
  const snap = await getDoc(ref);
  if (!snap.exists()) return alert("Student not found!");
  let assigned = {}; let i = 1;
  for (let u in courseUnits) {
    assigned[u] = document.getElementById("unitCheck" + i).checked;
    i++;
  }
  await updateDoc(ref, { allowedUnits: assigned });
  alert("Assignments saved!");
};

/* ================= STUDENT LOGIN ================= */
window.studentLogin = async function () {
  const name = document.getElementById("studentName").value.trim();
  const pin = document.getElementById("studentPin").value.trim();
  if (!name || !pin) return alert("Enter username and PIN");
  try {
    const snap = await getDoc(doc(db, "students", name));
    if (!snap.exists()) return alert("Student not found!");
    const data = snap.data();
    if (data.pin === pin) {
      currentStudent = name;
      show("studentMenu");
      loadStudentUnits();
    } else alert("Incorrect PIN!");
  } catch (err) {
    console.error(err);
    alert("Error connecting to database");
  }
};

/* ================= LOAD STUDENT UNITS ================= */
async function loadStudentUnits() {
  const snap = await getDoc(doc(db, "students", currentStudent));
  const data = snap.data();
  const div = document.getElementById("unitButtons");
  div.innerHTML = "";
  for (let u in courseUnits) {
    if (data.allowedUnits[u]) {
      const btn = document.createElement("button");
      btn.innerText = courseUnits[u].title;
      btn.onclick = () => startUnit(u);
      div.appendChild(btn);
    }
  }
}

/* ================= START UNIT ================= */
window.startUnit = function (u) {
  if (!questionBank[u]) return alert("No questions added yet for this unit.");
  currentUnitKey = u;
  currentUnitData = questionBank[u];
  currentQuestionIndex = 0;
  score = 0;
  shuffle(currentUnitData);
  show("game");
  showQuestion();
};

function showQuestion() {
  const q = currentUnitData[currentQuestionIndex];
  document.getElementById("unitTitle").innerText = courseUnits[currentUnitKey].title;
  document.getElementById("question").innerText = q.q;
  const div = document.getElementById("answers");
  div.innerHTML = "";
  shuffle(q.a);
  q.a.forEach(ans => {
    const btn = document.createElement("button");
    btn.innerText = ans.text;
    btn.onclick = () => checkAnswer(ans.correct);
    div.appendChild(btn);
  });
}

/* ================= CHECK ANSWER ================= */
async function checkAnswer(correct) {
  if (correct) score += 20;
  currentQuestionIndex++;
  if (currentQuestionIndex < currentUnitData.length) {
    showQuestion();
  } else {
    const ref = doc(db, "students", currentStudent);
    const snap = await getDoc(ref);
    const total = snap.data().score + score;
    await updateDoc(ref, { score: total });
    alert(`Unit Complete! Score earned: ${score}`);
    show("studentMenu");
    loadStudentUnits();
  }
}

/* ================= LEADERBOARD ================= */
async function loadLeaderboard() {
  const div = document.getElementById("board");
  div.innerHTML = "";
  const qSnap = query(collection(db, "students"), orderBy("score", "desc"));
  const snaps = await getDocs(qSnap);
  snaps.forEach(docSnap => {
    div.innerHTML += "üèÜ " + docSnap.id + " : " + docSnap.data().score + " points<br>";
  });
}

</script>

<style>
body{margin:0;font-family:Arial;background:#000014;color:white;text-align:center;}
.screen{display:none;padding:30px;}
#login{display:block;}
button,input{padding:10px;margin:10px;border-radius:8px;border:none;}
button{background:orange;cursor:pointer;}
button:hover{background:white;color:black;}
</style>

<body>

<h1>üè´ ECHS KY Earth & Space Science</h1>
<button id="musicBtn" onclick="toggleMusic()">üîá Music OFF</button>

<!-- LOGIN -->
<div id="login" class="screen">
<h2>Student Login</h2>
<input id="studentName" placeholder="Username">
<input id="studentPin" placeholder="4-digit PIN">
<button onclick="studentLogin()">Login</button>

<h2>Teacher Login</h2>
<input id="teacherPass" type="password" placeholder="Password">
<button onclick="teacherLogin()">Login</button>
</div>

<!-- TEACHER DASHBOARD -->
<div id="dashboard" class="screen">
<h2>Teacher Dashboard</h2>

<h3>Add Student</h3>
<input id="newStudent" placeholder="Username">
<input id="newPin" placeholder="PIN (4 digits)">
<button onclick="addStudent()">Add Student</button>

<h3>Leaderboard</h3>
<div id="board"></div>

<h3>Assign Units</h3>
<input id="assignStudent" placeholder="Student Username"><br>
<div id="unitAssignList"></div>
<button onclick="saveAssignments()">Save Assignments</button>
</div>

<!-- STUDENT MENU -->
<div id="studentMenu" class="screen">
<h2>Your Assigned Units</h2>
<div id="unitButtons"></div>
</div>

<!-- GAME -->
<div id="game" class="screen">
<h2 id="unitTitle"></h2>
<p id="question"></p>
<div id="answers"></div>
</div>

</body>
</html>
